public sealed class SqlDbConnectionFactory : IDbConnectionFactory
{
    private readonly string _connString;

    public SqlDbConnectionFactory(GEF_DbContext db, IConfiguration config)
    {
        // Prefer the EF connection string; fall back to config.
        _connString = db.Database.GetConnectionString()
                      ?? config.GetConnectionString("GefDb")
                      ?? throw new InvalidOperationException("GefDb connection string is missing.");
    }

    public async Task<DbConnection> OpenAsync(CancellationToken ct)
    {
        var conn = new SqlConnection(_connString);
        await conn.OpenAsync(ct);
        return conn;
    }
}
