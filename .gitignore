CREATE OR ALTER PROCEDURE dbo.sp_RefreshCsfFeed_Org
  @OrgID INT
AS
BEGIN
  SET NOCOUNT ON;

  ;WITH MapSubcats AS (
    SELECT DISTINCT m.CSF2SubcatID
    FROM stg.Org_CSF1_AttrBaseline b
    JOIN ref.CSF1_to_CSF2_SubcategoryMap m
      ON m.CSF1SubcatID = b.CSF1SubcatID
    WHERE b.OrgID = @OrgID
  ),
  CustomSubcats AS (
    SELECT DISTINCT c.CSF2SubcatID
    FROM dbo.Org_CustomCsf2Attribute c
    WHERE c.OrgID = @OrgID
  ),
  AllSubcats AS (
    SELECT CSF2SubcatID FROM MapSubcats
    UNION
    SELECT CSF2SubcatID FROM CustomSubcats
  )
  SELECT CSF2SubcatID INTO #Todo FROM AllSubcats;

  DECLARE @sid INT;
  WHILE EXISTS (SELECT 1 FROM #Todo)
  BEGIN
    SELECT TOP (1) @sid = CSF2SubcatID FROM #Todo ORDER BY CSF2SubcatID;
    EXEC dbo.sp_RefreshCsfFeed_Subcat @OrgID = @OrgID, @CSF2SubcategoryID = @sid;
    DELETE FROM #Todo WHERE CSF2SubcatID = @sid;
  END
END
GO
