-- dbo.Org_CustomCsf2Attribute
-- PURPOSE: Org-specific **custom** attributes at CSF 2.0 subcategory level.
-- NOTE: AttributeNum is backend-assigned (>=15) per (OrgID, CSF2SubcategoryID, MaturityLevel).
--       Attestation enums: 'Meet' | 'Partial Meet' | 'Does Not Meet'
--       Soft delete via IsActive.

IF OBJECT_ID('dbo.Org_CustomCsf2Attribute','U') IS NULL
CREATE TABLE dbo.Org_CustomCsf2Attribute
(
  OrgID               INT            NOT NULL,
  CSF2SubcategoryID   INT            NOT NULL,
  MaturityLevel       TINYINT        NOT NULL,        -- 3 or 4
  AttributeNum        INT            NOT NULL,        -- auto-assigned (>=15)

  Definition          NVARCHAR(500)  NOT NULL,
  Attestation         VARCHAR(20)    NOT NULL,        -- Meet | Partial Meet | Does Not Meet

  /* Optional governance (enable later if needed)
  IsApproved          BIT            NOT NULL CONSTRAINT DF_Custom_IsApproved DEFAULT (0),
  */

  IsActive            BIT            NOT NULL CONSTRAINT DF_Custom_IsActive   DEFAULT (1),

  CreatedBy           NVARCHAR(128)  NOT NULL,
  CreatedAt           DATETIME2(3)   NOT NULL CONSTRAINT DF_Custom_CreatedAt  DEFAULT SYSUTCDATETIME(),
  ModifiedBy          NVARCHAR(128)  NOT NULL,
  ModifiedAt          DATETIME2(3)   NOT NULL CONSTRAINT DF_Custom_ModifiedAt DEFAULT SYSUTCDATETIME(),

  CONSTRAINT PK_Org_CustomCsf2Attribute
    PRIMARY KEY CLUSTERED (OrgID, CSF2SubcategoryID, MaturityLevel, AttributeNum),

  CONSTRAINT FK_CustomAttr_Org
    FOREIGN KEY (OrgID)             REFERENCES dbo.Org(OrgID),
  CONSTRAINT FK_CustomAttr_CSF2Subcat
    FOREIGN KEY (CSF2SubcategoryID) REFERENCES ref.CSF2_Subcategory(SubcategoryID),

  CONSTRAINT CK_Custom_ML        CHECK (MaturityLevel IN (3,4)),
  CONSTRAINT CK_Custom_Att       CHECK (Attestation IN ('Meet','Partial Meet','Does Not Meet')),
  CONSTRAINT CK_Custom_AttrNum   CHECK (AttributeNum >= 15)
);
GO

-- Read-path index: hot filters by Org/Subcat; includes columns the UI needs quickly
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name='IX_Custom_Org_Subcat' AND object_id=OBJECT_ID('dbo.Org_CustomCsf2Attribute'))
CREATE NONCLUSTERED INDEX IX_Custom_Org_Subcat
  ON dbo.Org_CustomCsf2Attribute (OrgID, CSF2SubcategoryID)
  INCLUDE (MaturityLevel, AttributeNum, Definition, Attestation, /*IsApproved,*/ IsActive, ModifiedAt);
GO

-- Optional: filtered index to speed common reads for only active rows
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name='IX_Custom_Active' AND object_id=OBJECT_ID('dbo.Org_CustomCsf2Attribute'))
CREATE NONCLUSTERED INDEX IX_Custom_Active
  ON dbo.Org_CustomCsf2Attribute (OrgID, CSF2SubcategoryID, MaturityLevel, AttributeNum)
  INCLUDE (Definition, Attestation, ModifiedAt)
  WHERE IsActive = 1;
GO
