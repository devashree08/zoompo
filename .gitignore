# Authorization Overview

Employee (SSO) ──► Portal API
   │                 │
   │     SSO headers/Items (eid, username, …)
   ▼                 │
[Identity middleware]│
   │  looks up user’s policies via stored proc
   ▼                 │
[Policy claims stamped on the user]
   │                 │
   ▼                 ▼
[Authorize(Policy=…)] + [CustomerUpdateOnly filter]
   │
   └─► Decision: Read (default) or Write (if policy allows)


| AD Group                           | Policies granted                    | Where they can write (beyond read-only)          |
| ---------------------------------- | ----------------------------------- | ------------------------------------------------ |
| **GEF\_PORTAL\_ADMINS**            | `Admin` (implies all edit policies) | **Every** write endpoint + admin tools           |
| **GEF\_PORTAL\_ACCOUNT\_MANAGERS** | `Edit.CustomerUpdate`               | **Customer Update only** on Request, TDM, Access |
| **GEF\_PORTAL\_OTDP**              | `Edit.OTDP.All`                     | OTDP page                                        |
| **GEF\_PORTAL\_TDM**               | `Edit.TDM.All`                      | TDM page                                         |
| **GEF\_PORTAL\_ACCESS**            | `Edit.Access.All`                   | Access Mgmt page                                 |
| **GEF\_PORTAL\_GSAM**              | `Edit.GSAM.All`                     | GSAM page                                        |
| **GEF\_PORTAL\_READONLY**          | *(no edit policy)*                  | Read-only                                        |


Special rules (plain English)

Read-only for everyone by default (must be signed in).

Admins can do everything, including admin tools (Selection Tags, Change Log).

Account Managers can only edit the Customer Update field on Request, TDM, Access—no other fields.

OTDP/TDM/Access/GSAM groups can fully edit their own page.

If someone is in two groups, they get both sets of rights.


## Identity inputs (from SSO)
- Items: `pzid`, `firstName`, `lastName`, `eid`, `email` (fallback to same-named headers).
- Middleware builds an authenticated principal and stamps policies from the DB.

## Claim types
- `portal:policy` — one per effective policy (value = policy name).
- `portal:eid`, `Name` (username), `GivenName`, `Surname`, `Email` — echoes from SSO.

## Baseline policies (constants available in code)
- `Admin` — full access across the portal.
- `Edit.OTDP.All` — write access on OTDP endpoints.
- `Edit.TDM.All` — write access on TDM endpoints.
- `Edit.Access.All` — write access on Access Management endpoints.
- `Edit.GSAM.All` — write access on GSAM endpoints.
- `Edit.CustomerUpdate` — limited write access: “Customer Update” field on Request/TDM/Access pages.

> Additional policies may be introduced by the DB (stored proc `dbo.usp_PortalPolicies_GetForUser`) and are automatically recognized by the app via the **dynamic policy provider**.

## Group-to-policy mapping (Phase 1)
| AD Group                       | Policies Granted                        |
|--------------------------------|-----------------------------------------|
| GEF_PORTAL_ADMINS              | Admin (implies all edit policies)       |
| GEF_PORTAL_ACCOUNT_MANAGERS    | Edit.CustomerUpdate                     |
| GEF_PORTAL_OTDP                | Edit.OTDP.All                           |
| GEF_PORTAL_TDM                 | Edit.TDM.All                            |
| GEF_PORTAL_ACCESS              | Edit.Access.All                         |
| GEF_PORTAL_GSAM                | Edit.GSAM.All                           |
| GEF_PORTAL_READONLY            | (no edit policy; read-only)             |

**Multiple memberships**: union of policies; Admin supersedes.

## Default behavior (Option A)
- All **authenticated** users can perform **GET** (read-only).
- **Write** endpoints must require the corresponding policy (e.g., `Edit.TDM.All`), Admin passes all.

## Propagation expectations
- AD feed refresh: every 3–4 hours.
- App cache TTL: 5 minutes (configurable in `Auth:PolicyCache:Minutes`).
- Worst-case role change to take effect: feed interval + TTL (~4h 5m).

## Naming conventions
- Policies are `Pascal.Case.With.Dots` (e.g., `Edit.TDM.All`).
- Claim types use a `portal:` prefix (e.g., `portal:policy`, `portal:eid`).

