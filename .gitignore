IF OBJECT_ID('dbo.Org_AttributeSelection_Audit','U') IS NULL
CREATE TABLE dbo.Org_AttributeSelection_Audit
(
  AuditID                   BIGINT        IDENTITY(1,1) PRIMARY KEY,
  Operation                 CHAR(1)       NOT NULL,   -- I/U/D
  ChangedAt                 DATETIME2(3)  NOT NULL,
  ChangedBy                 SYSNAME       NOT NULL,

  OrgID                     INT           NOT NULL,
  CSF2SubcategoryID         INT           NOT NULL,
  CSF1SubcategoryID         INT           NOT NULL,
  MaturityLevel             TINYINT       NOT NULL,
  AttributeNum              INT           NOT NULL,

  Old_Ent_Subcat_Attr       NVARCHAR(100) NULL,
  New_Ent_Subcat_Attr       NVARCHAR(100) NULL,
  Old_SelectionStatus       VARCHAR(20)   NULL,
  New_SelectionStatus       VARCHAR(20)   NULL,
  Old_SelectionAttestation  VARCHAR(20)   NULL,
  New_SelectionAttestation  VARCHAR(20)   NULL
);
GO


IF OBJECT_ID('dbo.trg_Org_AttributeSelection_Audit','TR') IS NOT NULL
  DROP TRIGGER dbo.trg_Org_AttributeSelection_Audit;
GO
CREATE TRIGGER dbo.trg_Org_AttributeSelection_Audit
ON dbo.Org_AttributeSelection
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
  SET NOCOUNT ON;
  DECLARE @now DATETIME2(3) = SYSUTCDATETIME();

  -- INSERTS
  INSERT dbo.Org_AttributeSelection_Audit
    (Operation, ChangedAt, ChangedBy, OrgID, CSF2SubcategoryID, CSF1SubcategoryID, MaturityLevel, AttributeNum,
     Old_Ent_Subcat_Attr, New_Ent_Subcat_Attr, Old_SelectionStatus, New_SelectionStatus,
     Old_SelectionAttestation, New_SelectionAttestation)
  SELECT 'I', @now, COALESCE(i.ModifiedBy, i.CreatedBy, SUSER_SNAME()),
         i.OrgID, i.CSF2SubcategoryID, i.CSF1SubcategoryID, i.MaturityLevel, i.AttributeNum,
         NULL, i.Ent_Subcat_Attr, NULL, i.SelectionStatus, NULL, i.SelectionAttestation
  FROM inserted i
  LEFT JOIN deleted d
    ON d.OrgID=i.OrgID AND d.CSF2SubcategoryID=i.CSF2SubcategoryID
   AND d.CSF1SubcategoryID=i.CSF1SubcategoryID AND d.MaturityLevel=i.MaturityLevel AND d.AttributeNum=i.AttributeNum
  WHERE d.OrgID IS NULL;

  -- UPDATES
  INSERT dbo.Org_AttributeSelection_Audit
    (Operation, ChangedAt, ChangedBy, OrgID, CSF2SubcategoryID, CSF1SubcategoryID, MaturityLevel, AttributeNum,
     Old_Ent_Subcat_Attr, New_Ent_Subcat_Attr, Old_SelectionStatus, New_SelectionStatus,
     Old_SelectionAttestation, New_SelectionAttestation)
  SELECT 'U', @now, COALESCE(i.ModifiedBy, d.ModifiedBy, SUSER_SNAME()),
         i.OrgID, i.CSF2SubcategoryID, i.CSF1SubcategoryID, i.MaturityLevel, i.AttributeNum,
         d.Ent_Subcat_Attr, i.Ent_Subcat_Attr,
         d.SelectionStatus, i.SelectionStatus,
         d.SelectionAttestation, i.SelectionAttestation
  FROM inserted i
  INNER JOIN deleted d
    ON d.OrgID=i.OrgID AND d.CSF2SubcategoryID=i.CSF2SubcategoryID
   AND d.CSF1SubcategoryID=i.CSF1SubcategoryID AND d.MaturityLevel=i.MaturityLevel AND d.AttributeNum=i.AttributeNum;

  -- DELETES
  INSERT dbo.Org_AttributeSelection_Audit
    (Operation, ChangedAt, ChangedBy, OrgID, CSF2SubcategoryID, CSF1SubcategoryID, MaturityLevel, AttributeNum,
     Old_Ent_Subcat_Attr, New_Ent_Subcat_Attr, Old_SelectionStatus, New_SelectionStatus,
     Old_SelectionAttestation, New_SelectionAttestation)
  SELECT 'D', @now, COALESCE(d.ModifiedBy, d.CreatedBy, SUSER_SNAME()),
         d.OrgID, d.CSF2SubcategoryID, d.CSF1SubcategoryID, d.MaturityLevel, d.AttributeNum,
         d.Ent_Subcat_Attr, NULL, d.SelectionStatus, NULL, d.SelectionAttestation, NULL
  FROM deleted d
  LEFT JOIN inserted i
    ON i.OrgID=d.OrgID AND i.CSF2SubcategoryID=d.CSF2SubcategoryID
   AND i.CSF1SubcategoryID=d.CSF1SubcategoryID AND i.MaturityLevel=d.MaturityLevel AND i.AttributeNum=d.AttributeNum
  WHERE i.OrgID IS NULL;
END
GO
